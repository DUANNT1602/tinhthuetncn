<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxAnalytics Pro - Bi·ªÉu ƒë·ªì th√¥ng minh</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { 
            --primary-gradient: linear-gradient(135deg, #FF8C42 0%, #F95211 100%);
            --glass: rgba(255, 255, 255, 0.85);
            --text-main: #2D3436;
            --text-sub: #636E72;
            --accent: #F95211;
        }

        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            background: radial-gradient(circle at top right, #FFB382, #FF8C42);
            background-attachment: fixed;
            display: flex; justify-content: center; 
            padding: 40px 20px; color: var(--text-main); 
            min-height: 100vh; margin: 0;
            top: 0 !important;
        }
        
        .container { 
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 40px; border-radius: 30px; 
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.4);
            width: 100%; max-width: 650px; 
        }

        .logo-wrapper h2 { 
            font-weight: 800; font-size: 26px; margin: 0;
            background: var(--primary-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .tab-group { margin-bottom: 20px; }
        .tab-label { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 1px; }
        .tab-container { display: flex; background: rgba(0,0,0,0.04); border-radius: 15px; padding: 5px; }
        .tab { 
            flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 12px; 
            font-weight: 600; font-size: 13px; transition: 0.3s; color: var(--text-sub); 
        }
        .tab.active { background: white; color: var(--accent); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        input, select { 
            width: 100%; padding: 14px 18px; border: 1px solid rgba(0,0,0,0.08); border-radius: 15px; 
            background: white; font-size: 15px; outline: none; font-family: inherit; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(249, 82, 17, 0.1); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        button.btn-calc { 
            width: 100%; padding: 18px; background: var(--primary-gradient); 
            color: white; border: none; border-radius: 20px; cursor: pointer; 
            font-size: 16px; font-weight: 700; box-shadow: 0 10px 25px rgba(249, 82, 17, 0.3);
            transition: 0.3s; margin-top: 10px;
        }

        #result-card {
            display: none; margin-top: 30px; background: white; 
            padding: 30px; border-radius: 25px; animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Bi·ªÉu ƒë·ªì r·ªông h∆°n ƒë·ªÉ hi·ªÉn th·ªã s·ªë r√µ h∆°n */
        .chart-container { width: 320px; margin: 0 auto 25px auto; position: relative; }
        
        .res-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #F1F2F6; }
        .res-total { font-size: 28px; color: var(--accent); font-weight: 800; text-align: center; margin-top: 10px; }

        .compare-box {
            margin-top: 20px; padding: 15px; background: #FFF9F6; 
            border-left: 4px solid var(--accent); border-radius: 12px; font-size: 13px;
        }

        #btn-group { display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn-download { background: #2D3436; color: white; padding: 15px; border: none; border-radius: 15px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-wrapper">
        <h2 class="notranslate">TaxAnalytics Pro</h2>
        <p style="color: var(--text-sub); font-size: 13px; margin-top: 5px;">C√¥ng c·ª• ph√¢n t√≠ch thu nh·∫≠p ƒëa chi·ªÅu</p>
    </div>

    <div class="tab-group" style="margin-top: 25px;">
        <span class="tab-label">Quy ƒë·ªãnh t·ª´ 2026</span>
        <div class="tab-container">
            <div id="tab-gross-2026" class="tab active" onclick="setMode('GROSS', 2026)">Gross ‚Üí Net</div>
            <div id="tab-net-2026" class="tab" onclick="setMode('NET', 2026)">Net ‚Üí Gross</div>
        </div>
    </div>

    <div class="tab-group">
        <span class="tab-label">Quy ƒë·ªãnh tr∆∞·ªõc 2025</span>
        <div class="tab-container">
            <div id="tab-gross-2025" class="tab" onclick="setMode('GROSS', 2025)">Gross ‚Üí Net</div>
            <div id="tab-net-2025" class="tab" onclick="setMode('NET', 2025)">Net ‚Üí Gross</div>
        </div>
    </div>

    <div class="form-group">
        <label id="income-label">Thu nh·∫≠p h√†ng th√°ng (VNƒê)</label>
        <input type="text" id="income-input" oninput="formatCurrency(this)" placeholder="Nh·∫≠p s·ªë ti·ªÅn...">
    </div>

    <div class="grid">
        <div class="form-group">
            <label>Ng∆∞·ªùi ph·ª• thu·ªôc</label>
            <input type="number" id="dependents" value="0">
        </div>
        <div class="form-group">
            <label>Kho·∫£n gi·∫£m tr·ª´ kh√°c</label>
            <input type="text" id="nonTaxable" oninput="formatCurrency(this)" placeholder="Nh·∫≠p s·ªë gi·∫£m tr·ª´">
        </div>
    </div>

    <div class="form-group">
        <label>M·ª©c ƒë√≥ng B·∫£o hi·ªÉm x√£ h·ªôi</label>
        <select id="insType" onchange="toggleIns()">
            <option value="full">ƒê√≥ng tr√™n 100% l∆∞∆°ng</option>
            <option value="custom">M·ª©c ƒë√≥ng c·ªë ƒë·ªãnh</option>
        </select>
        <input type="text" id="insCustom" style="display:none; margin-top:12px;" oninput="formatCurrency(this)" placeholder="M·ª©c l∆∞∆°ng ƒë√≥ng BH...">
    </div>

    <button class="btn-calc" onclick="process()">B·∫Øt ƒë·∫ßu ph√¢n t√≠ch</button>

    <div id="result-card">
        <div class="chart-container">
            <canvas id="taxChart"></canvas>
        </div>
        <div class="res-row"><span class="res-label">L∆∞∆°ng Gross</span><span class="res-value" id="web-gross"></span></div>
        <div class="res-row"><span class="res-label">B·∫£o hi·ªÉm (10.5%)</span><span class="res-value" id="web-bh"></span></div>
        <div class="res-row"><span class="res-label">Thu·∫ø TNCN</span><span class="res-value" id="web-tax" style="color:#EB4D4B"></span></div>
        <div style="text-align: center; margin-top: 15px;">
            <span style="font-size: 12px; color: var(--text-sub); font-weight: 700;">TH·ª∞C NH·∫¨N (NET)</span>
            <div class="res-total" id="web-net"></div>
        </div>
        <div id="web-compare" class="compare-box"></div>
    </div>

    <div id="btn-group">
        <button class="btn-download" onclick="exportPDF('a4')">T·∫£i b√°o c√°o PDF</button>
        <button class="btn-download" onclick="location.reload()" style="background:#636E72">T√≠nh to√°n l·∫°i</button>
    </div>
</div>

<script>
    let currentMode = 'GROSS', currentYear = 2026, myChart = null;

    // ƒêƒÉng k√Ω Plugin hi·ªÉn th·ªã s·ªë li·ªáu
    Chart.register(ChartDataLabels);

    function setMode(m, y) {
        currentMode = m; currentYear = y;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${m.toLowerCase()}-${y}`).classList.add('active');
        document.getElementById('income-label').innerText = `Thu nh·∫≠p ${m} (${y})`;
    }

    function formatCurrency(i) {
        let v = i.value.replace(/\D/g, "");
        i.value = v ? Number(v).toLocaleString('en-US') : "";
    }
    function parseV(id) { return parseFloat(document.getElementById(id).value.replace(/,/g, "")) || 0; }
    function toggleIns() { document.getElementById('insCustom').style.display = document.getElementById('insType').value === 'custom' ? 'block' : 'none'; }

    function calcTax(gross, nonTax, deps, iType, iCustom, year) {
        let baseBH = (iType === 'full') ? gross : iCustom;
        let bh = baseBH * 0.105;
        let selfGT = (year === 2026) ? 15500000 : 11000000;
        let depGT = (year === 2026) ? 6200000 : 4400000;
        let tntt = Math.max(0, gross - nonTax - bh - (selfGT + deps * depGT));
        let tax = 0, ti = tntt / 1000000;

        if (year === 2026) {
            if (ti > 100) tax = (ti - 100) * 0.35 + 20.5;
            else if (ti > 60) tax = (ti - 60) * 0.3 + 8.5;
            else if (ti > 30) tax = (ti - 30) * 0.2 + 2.5;
            else if (ti > 10) tax = (ti - 10) * 0.1 + 0.5;
            else tax = ti * 0.05;
        } else {
            if (ti > 80) tax = (ti - 80) * 0.35 + 18.15;
            else if (ti > 52) tax = (ti - 52) * 0.3 + 9.75;
            else if (ti > 32) tax = (ti - 32) * 0.25 + 4.75;
            else if (ti > 18) tax = (ti - 18) * 0.2 + 1.95;
            else if (ti > 10) tax = (ti - 10) * 0.15 + 0.75;
            else if (ti > 5) tax = (ti - 5) * 0.1 + 0.25;
            else tax = ti * 0.05;
        }
        let tFinal = Math.round(tax * 1000000);
        return { bh, tax: tFinal, net: gross - bh - tFinal };
    }

    function updateChart(net, tax, bh) {
        const ctx = document.getElementById('taxChart').getContext('2d');
        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Th·ª±c nh·∫≠n', 'Thu·∫ø TNCN', 'B·∫£o hi·ªÉm'],
                datasets: [{
                    data: [net, tax, bh],
                    backgroundColor: ['#F95211', '#EB4D4B', '#2D3436'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value) => {
                            if (value < 500000) return ""; // Kh√¥ng hi·ªán n·∫øu s·ªë qu√° nh·ªè tr√°nh ƒë√® nhau
                            return (value / 1000000).toFixed(1) + "M";
                        }
                    }
                },
                cutout: '65%'
            }
        });
    }

    function process() {
        let input = parseV('income-input'), nonTax = parseV('nonTaxable'), deps = parseV('dependents');
        let iType = document.getElementById('insType').value, iCustom = parseV('insCustom');
        if(!input) return alert("Vui l√≤ng nh·∫≠p thu nh·∫≠p!");

        let fGross = input;
        if (currentMode === 'NET') {
            let l = input, h = input * 3;
            for(let i=0; i<50; i++) {
                fGross = (l + h) / 2;
                if (calcTax(fGross, nonTax, deps, iType, iCustom, currentYear).net < input) l = fGross; else h = fGross;
            }
        }

        let res = calcTax(fGross, nonTax, deps, iType, iCustom, currentYear);
        const fmt = n => Math.round(n).toLocaleString('en-US') + ' ƒë';
        
        document.getElementById('web-gross').innerText = fmt(fGross);
        document.getElementById('web-bh').innerText = fmt(res.bh);
        document.getElementById('web-tax').innerText = fmt(res.tax);
        document.getElementById('web-net').innerText = fmt(res.net);
        
        let comp = calcTax(fGross, nonTax, deps, iType, iCustom, (currentYear === 2026 ? 2025 : 2026));
        let diff = Math.abs(res.tax - comp.tax);
        document.getElementById('web-compare').innerHTML = `üí° <b>So s√°nh:</b> Lu·∫≠t nƒÉm ${(currentYear === 2026 ? 2025 : 2026)} n·ªôp ${fmt(comp.tax)} thu·∫ø. ${currentYear===2026?'Ti·∫øt ki·ªám':'N·ªôp th√™m'} <b>${fmt(diff)}</b>.`;

        updateChart(res.net, res.tax, res.bh);
        document.getElementById('result-card').style.display = 'block';
        document.getElementById('btn-group').style.display = 'grid';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function exportPDF(size) {
        const element = document.getElementById('result-card');
        html2pdf().set({ margin: 0.5, filename: 'Bao-cao-thu-nhap.pdf', html2canvas: { scale: 3 }, jsPDF: { format: size } }).from(element).save();
    }
</script>
</body>
</html>
